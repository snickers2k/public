blueprint:
  name: Schlafüberwachung mit Bewegungssensor und `occupied`-Prüfung (optional mit Android-TV Check)
  description: Dieser Blueprint überwacht, ob sich eine Person im Raum befindet (`occupied`), aber keine Bewegung erkannt wird. Optional wird der Android-TV-Status überprüft, bevor eine Aktion ausgeführt wird.
  domain: automation
  input:
    bewegungssensor:
      name: Bewegungssensor
      description: Wähle den Bewegungssensor aus, der den `occupied`-Status meldet.
      selector:
        entity:
          domain: binary_sensor
          device_class: motion

    android_tv:
      name: Android-TV (optional)
      description: Wähle das Entity für deinen Android-TV aus, das als Bedingung geprüft werden soll. Lasse das Feld leer, wenn keine TV-Überprüfung gewünscht ist.
      selector:
        entity:
          domain: media_player
      default: ""

    use_android_tv_check:
      name: Android-TV Check verwenden
      description: Aktiviere diese Option, wenn der Android-TV eingeschaltet sein muss, damit die Aktion ausgeführt wird.
      default: false
      selector:
        boolean:
        
    timer_duration:
      name: Timer Dauer ohne Bewegung
      description: Dauer, nach der die Aktion ausgeführt wird, wenn der Raum als belegt (`occupied`) gemeldet wird, aber keine Bewegung erkannt wird.
      default: "00:05:00"
      selector:
        time:

    action:
      name: Auszuführende Aktion
      description: Die Aktion, die ausgeführt werden soll, wenn der Raum als `occupied` gemeldet wird, aber keine Bewegung erkannt wird. Optional nur, wenn der TV eingeschaltet ist.
      default: []
      selector:
        action: {}

automation:
  - alias: 'Schlafüberwachung mit Bewegungssensor und `occupied`-Prüfung (optional mit Android-TV Check)'
    trigger:
      # Auslösen, wenn der Bewegungssensor auf `on` wechselt (Raum ist belegt)
      - platform: state
        entity_id: !input bewegungssensor
        to: 'on'
        
      # Auslösen, wenn keine Bewegung erkannt wird, obwohl der Raum belegt ist
      - platform: state
        entity_id: !input bewegungssensor
        to: 'off'
        for:
          minutes: "{{ (trigger.to_state.attributes.no_motion_duration or timer_duration) | int }}" # Zeitdauer ohne Bewegung (anpassbar)

    condition:
      # Bedingung: Android-TV muss an sein, wenn `use_android_tv_check` aktiviert ist
      - condition: template
        value_template: >
          {{ not is_state('input_boolean.use_android_tv_check', 'on') or
             (is_state('input_boolean.use_android_tv_check', 'on') and is_state('media_player.android_tv', 'on')) }}
          
    action:
      # Wenn `occupied` erkannt wurde und keine Bewegung
      - choose:
          - conditions:
              - condition: state
                entity_id: !input bewegungssensor
                state: 'on' # `on` bedeutet `occupied`
            sequence:
              - service: script.turn_off
                target:
                  entity_id: script.bewegung_timer_abgelaufen
              - service: script.turn_on
                target:
                  entity_id: script.bewegung_timer_abgelaufen
                data:
                  variables:
                    timer_duration: !input timer_duration
        default:
          - service: script.turn_off
            target:
              entity_id: script.bewegung_timer_abgelaufen

script:
  bewegung_timer_abgelaufen:
    alias: 'Bewegung Timer Abgelaufen'
    sequence:
      - delay: "{{ timer_duration }}"
      - condition: state
        entity_id: !input bewegungssensor
        state: 'on' # Der Sensor meldet `occupied`
      - condition: template
        value_template: >
          {{ not is_state('input_boolean.use_android_tv_check', 'on') or
             (is_state('input_boolean.use_android_tv_check', 'on') and is_state('media_player.android_tv', 'on')) }}
      - choose:
          - sequence: !input action
